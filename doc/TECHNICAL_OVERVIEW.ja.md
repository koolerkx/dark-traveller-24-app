[English](TECHNICAL_OVERVIEW.md) | [日本語](TECHNICAL_OVERVIEW.ja.md) | [繁體中文](TECHNICAL_OVERVIEW.zh-Hant.md)

# 技術概要：ダークトラベラー 24 アプリ

このドキュメントでは、ダークトラベラー 24 アプリケーションのアーキテクチャ、データフロー、およびコアコンポーネントに焦点を当て、ポイント形式で詳細な技術的内訳を説明します。

## 1. アプリケーションアーキテクチャとコンテキストプロバイダー

- **アーキテクチャスタイル**：React と Ionic フレームワークを使用したクライアントヘビーなシングルページアプリケーション（SPA）。
- **状態管理**：グローバルな状態とサービスは、React コンテキストプロバイダーの階層を介して管理されます。
- **依存性注入**：`main.tsx`のコンテキスト設定により、依存性注入の順序が確立されます。
  ```
  <FirebaseProvider>
    <RepositoryProvider>
      <AuthProvider>
        <App />
      </AuthProvider>
    </RepositoryProvider>
  </FirebaseProvider>
  ```

---

### コンテキストプロバイダーの詳細

- **`FirebaseProvider`**

  - **役割**：トップレベルのプロバイダー。Firebase バックエンドへの接続を初期化します。
  - **アクション**：
    - 環境変数から Firebase 設定を読み取ります。
    - コアの Firebase `app`および`analytics`インスタンスを初期化します。
  - **提供**：`app`および`analytics`オブジェクトをすべての子コンポーネントに提供します。

- **`RepositoryProvider`**

  - **役割**：データアクセス層をインスタンス化し、すべての Firestore ロジックを UI から抽象化します。
  - **依存関係**：Firebase `app`インスタンスを消費します。
  - **アクション**：
    - Firestore データベースインスタンス（`getFirestore`）を初期化します。
    - `PointRepository`および`UserRepository`のシングルトンインスタンスを作成して提供します。
  - **提供**：`pointRepository`および`userRepository`インスタンス。

- **`AuthProvider`**
  - **役割**：ユーザーの認証状態、セッション、および永続性を管理します。
  - **依存関係**：Firebase `app`インスタンスを消費します。
  - **アクション**：
    - Firebase Authentication を初期化し、`onAuthStateChanged`リスナーを設定します。
    - ログイン/ログアウトロジックを処理します。
    - `browserLocalPersistence`を使用してユーザーのログイン状態を維持します。
  - **提供**：`user`オブジェクト、`isAuthed`ブール値、および`isLoading`ブール値。

## 2. データリポジトリとクライアントサイド集計

- **コアロジックの場所**：アプリケーションのビジネスロジックは**リポジトリ層**（`src/repository/`）に集中しています。
- **責任**：
  - Firestore とのすべての通信を処理します。
  - クライアントサイドで複雑なデータ集計を実行して、生のデータからアプリケーションの状態を導出します。

---

### リポジトリの詳細

- **`UserRepository`**

  - **役割**：ユーザーデータに関連するすべての操作を管理します。
  - **メソッド**：
    - **`getUser(email)`**：`users`コレクションから単一のユーザープロファイルを取得します。
    - **`upgradeUser(user, upgradePointId)`**：
      - **目的**：ユーザーのレベルを上げます。
      - **ロジック**：
        - `USER_MAXIMUM_LEVEL`に対して検証します。
        - 重複したアップグレードを防ぎます。
        - `USER_UPGRADE`イベントをログに記録します。
    - **`capturePoint(user, pointId)`**：
      - **目的**：ポイントをアトミックにキャプチャします。他のユーザーから奪う可能性があります。
      - **実行**：データの整合性のために Firestore トランザクション内で実行されます。
      - **フロー**：
        1.  **状態の取得**：すべての`users`とターゲット`point`を読み取ります。
        2.  **検証**：自己再キャプチャ（`CapturedPointAlreadyCapturedError`）とクールダウン違反（`CapturedPointInCooldownError`）を確認します。
        3.  **対戦相手のクリア**：ポイントを奪う場合、対戦相手のキャプチャしたポイントに`expiredAt`を設定します。
        4.  **新しいキャプチャの追加**：現在のユーザーの`capturedPoints`配列に新しいアクティブなポイントを追加します。
        5.  **イベントのログ記録**：トランザクション後に`CLEAR_POINT`および`CAPTURE_POINT`イベントをログに記録します。
    - **`getRanking()`**：
      - **目的**：リアルタイムのリーダーボードを生成します。
      - **集計**：
        - すべてのユーザーを取得します。
        - クライアントサイドで各ユーザーのスコア（`attackedPower`）を計算します。
        - 計算されたスコアでユーザーリストを並べ替えます。

- **`PointRepository`**
  - **役割**：静的なチェックポイントデータとその動的なリアルタイムステータスを管理します。
  - **メソッド**：
    - **`getPoints()`**：利用可能なすべてのポイントの静的リストを取得します。
    - **`getPointsWithCapturedInfo()`**：
      - **目的**：マップビューにすべてのポイントの完全なリアルタイムステータスを提供します。
      - **集計**：
        1.  効率的な 2 つのクエリで、すべての`users`と`points`を取得します。
        2.  各ユニークなポイントの*最新の*キャプチャイベントのルックアップマップを作成します。
        3.  静的なポイントデータを動的な`PointStatus`（`new`、`captured`など）と所有者情報でエンリッチします。

## 3. ビューとルーティング

- **UI 編成**：UI はページに編成され、ルーティングは`IonReactRouter`によって制御されます。
- **ナビゲーション**：メインのタブバーがビュー間の主要なナビゲーションを提供します。

---

### 構造の詳細

- **ルーティング（`App.tsx`および`route.tsx`）**

  - **エンジン**：ルートは`<IonRouterOutlet>`内で定義されます。
  - **保護**：`AuthRoute`コンポーネントは保護されたルートをラップし、`isAuthed`フラグを確認して、ユーザーが認証されていない場合は`/login`にリダイレクトします。

- **タブベースのナビゲーションとページ**

  - **`/home`**：ユーザーの進捗と目的を示すメインダッシュボード。
  - **`/map`**：`pointRepository.getPointsWithCapturedInfo()`のデータを使用してポイントマーカーをレンダリングするインタラクティブな Leaflet マップ。
  - **`/scan`**：`capturePoint`または`upgradeUser`リポジトリメソッドをトリガーする QR コードスキャンインターフェイス。
  - **`/ranking`**：`userRepository.getRanking()`からソートされたデータを表示するリーダーボードページ。
  - **`/profile`**：`userRepository.getUser()`から現在のユーザーのデータを表示するユーザー統計ページ。

- **コンポーネント構造**
  - **`pages/`**：フルスクリーンビューに対応する「スマート」コンポーネント。データの取得とビューステートの管理を担当します。
  - **`components/`**：再利用性の高い「ダム」なプレゼンテーションコンポーネント。すべてのデータと関数をプロップ経由で受け取ります。
